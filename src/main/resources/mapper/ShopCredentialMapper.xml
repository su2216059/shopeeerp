<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.shopeeerp.mapper.ShopCredentialMapper">

    <resultMap id="CredentialResultMap" type="com.example.shopeeerp.pojo.ShopCredential">
        <id property="id" column="id"/>
        <result property="shopId" column="shop_id"/>
        <result property="clientId" column="client_id"/>
        <result property="apiKeyEncrypted" column="api_key_encrypted"/>
        <result property="apiSecretEncrypted" column="api_secret_encrypted"/>
        <result property="accessTokenEncrypted" column="access_token_encrypted"/>
        <result property="refreshTokenEncrypted" column="refresh_token_encrypted"/>
        <result property="tokenExpiresAt" column="token_expires_at"/>
        <result property="credentialType" column="credential_type"/>
        <result property="status" column="status"/>
        <result property="lastUsedAt" column="last_used_at"/>
        <result property="lastVerifiedAt" column="last_verified_at"/>
        <result property="rateLimitPerMinute" column="rate_limit_per_minute"/>
        <result property="rateLimitPerDay" column="rate_limit_per_day"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO shop_credential (shop_id, client_id, api_key_encrypted, api_secret_encrypted,
                                     access_token_encrypted, refresh_token_encrypted, token_expires_at,
                                     credential_type, status, rate_limit_per_minute, rate_limit_per_day,
                                     created_at, updated_at)
        VALUES (#{shopId}, #{clientId}, #{apiKeyEncrypted}, #{apiSecretEncrypted},
                #{accessTokenEncrypted}, #{refreshTokenEncrypted}, #{tokenExpiresAt},
                #{credentialType}, #{status}, #{rateLimitPerMinute}, #{rateLimitPerDay},
                NOW(), NOW())
    </insert>

    <update id="update">
        UPDATE shop_credential SET
            client_id = #{clientId},
            api_key_encrypted = #{apiKeyEncrypted},
            api_secret_encrypted = #{apiSecretEncrypted},
            access_token_encrypted = #{accessTokenEncrypted},
            refresh_token_encrypted = #{refreshTokenEncrypted},
            token_expires_at = #{tokenExpiresAt},
            credential_type = #{credentialType},
            status = #{status},
            rate_limit_per_minute = #{rateLimitPerMinute},
            rate_limit_per_day = #{rateLimitPerDay},
            updated_at = NOW()
        WHERE shop_id = #{shopId}
    </update>

    <insert id="upsert">
        INSERT INTO shop_credential (shop_id, client_id, api_key_encrypted, api_secret_encrypted,
                                     credential_type, status, created_at, updated_at)
        VALUES (#{shopId}, #{clientId}, #{apiKeyEncrypted}, #{apiSecretEncrypted},
                #{credentialType}, #{status}, NOW(), NOW())
        ON DUPLICATE KEY UPDATE
            client_id = VALUES(client_id),
            api_key_encrypted = VALUES(api_key_encrypted),
            api_secret_encrypted = VALUES(api_secret_encrypted),
            credential_type = VALUES(credential_type),
            status = VALUES(status),
            updated_at = NOW()
    </insert>

    <delete id="deleteByShopId">
        DELETE FROM shop_credential WHERE shop_id = #{shopId}
    </delete>

    <select id="selectByShopId" resultMap="CredentialResultMap">
        SELECT * FROM shop_credential WHERE shop_id = #{shopId}
    </select>

    <update id="updateStatus">
        UPDATE shop_credential SET status = #{status}, updated_at = NOW() WHERE shop_id = #{shopId}
    </update>

    <update id="updateLastUsed">
        UPDATE shop_credential SET last_used_at = NOW() WHERE shop_id = #{shopId}
    </update>

    <update id="updateLastVerified">
        UPDATE shop_credential SET last_verified_at = NOW(), status = 'active', updated_at = NOW()
        WHERE shop_id = #{shopId}
    </update>

</mapper>
