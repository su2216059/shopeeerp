<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.shopeeerp.mapper.MarketScrapeTaskMapper">

    <resultMap id="BaseResultMap" type="com.example.shopeeerp.pojo.MarketScrapeTask">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="platform" property="platform" jdbcType="VARCHAR"/>
        <result column="market" property="market" jdbcType="VARCHAR"/>
        <result column="url" property="url" jdbcType="VARCHAR"/>
        <result column="data_type" property="dataType" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="priority" property="priority" jdbcType="INTEGER"/>
        <result column="scheduled_at" property="scheduledAt" jdbcType="TIMESTAMP"/>
        <result column="fetched_at" property="fetchedAt" jdbcType="TIMESTAMP"/>
        <result column="retry_count" property="retryCount" jdbcType="INTEGER"/>
        <result column="max_retries" property="maxRetries" jdbcType="INTEGER"/>
        <result column="last_error" property="lastError" jdbcType="VARCHAR"/>
        <result column="payload_json" property="payloadJson" jdbcType="LONGVARCHAR"/>
        <result column="lock_owner" property="lockOwner" jdbcType="VARCHAR"/>
        <result column="lock_at" property="lockAt" jdbcType="TIMESTAMP"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, platform, market, url, data_type, status, priority, scheduled_at, fetched_at,
        retry_count, max_retries, last_error, payload_json, lock_owner, lock_at, created_at, updated_at
    </sql>

    <insert id="insert" parameterType="com.example.shopeeerp.pojo.MarketScrapeTask">
        INSERT INTO market_scrape_task (
            platform, market, url, data_type, status, priority, scheduled_at, fetched_at,
            retry_count, max_retries, last_error, payload_json, lock_owner, lock_at,
            created_at, updated_at
        ) VALUES (
            #{platform}, #{market}, #{url}, #{dataType}, #{status}, #{priority}, #{scheduledAt}, #{fetchedAt},
            #{retryCount}, #{maxRetries}, #{lastError}, #{payloadJson}, #{lockOwner}, #{lockAt},
            #{createdAt}, #{updatedAt}
        )
    </insert>

    <insert id="insertBatch" parameterType="java.util.List">
        INSERT INTO market_scrape_task (
            platform, market, url, data_type, status, priority, scheduled_at, fetched_at,
            retry_count, max_retries, last_error, payload_json, lock_owner, lock_at,
            created_at, updated_at
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.platform}, #{item.market}, #{item.url}, #{item.dataType}, #{item.status},
                #{item.priority}, #{item.scheduledAt}, #{item.fetchedAt}, #{item.retryCount},
                #{item.maxRetries}, #{item.lastError}, #{item.payloadJson}, #{item.lockOwner},
                #{item.lockAt}, #{item.createdAt}, #{item.updatedAt}
            )
        </foreach>
    </insert>

    <select id="selectPendingForUpdate" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM market_scrape_task
        WHERE status IN ('PENDING', 'RETRY')
          AND (scheduled_at IS NULL OR scheduled_at <![CDATA[<=]]> #{now})
        ORDER BY priority DESC, scheduled_at ASC, id ASC
        LIMIT #{limit}
        FOR UPDATE
    </select>

    <update id="markInProgress">
        UPDATE market_scrape_task
        SET status = 'IN_PROGRESS',
            lock_owner = #{lockOwner},
            lock_at = #{lockAt},
            updated_at = #{updatedAt}
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="markSuccess">
        UPDATE market_scrape_task
        SET status = 'DONE',
            fetched_at = #{fetchedAt},
            last_error = NULL,
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <update id="markFailure">
        UPDATE market_scrape_task
        SET retry_count = COALESCE(retry_count, 0) + 1,
            status = CASE
                WHEN COALESCE(retry_count, 0) + 1 &lt; COALESCE(max_retries, 0) THEN 'RETRY'
                ELSE 'FAILED'
            END,
            last_error = #{error},
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <!-- 更新任务进度 -->
    <update id="updateProgress">
        UPDATE market_scrape_task
        SET payload_json = #{progressJson},
            updated_at = #{updatedAt}
        WHERE id = #{id}
          AND lock_owner = #{workerId}
    </update>

    <!-- 完成任务 -->
    <update id="completeTask">
        UPDATE market_scrape_task
        SET status = #{status},
            fetched_at = #{fetchedAt},
            last_error = #{errorMessage},
            updated_at = #{updatedAt}
        WHERE id = #{id}
          AND lock_owner = #{workerId}
    </update>

    <!-- 释放超时任务 -->
    <update id="releaseTimeoutTasks">
        UPDATE market_scrape_task
        SET status = 'PENDING',
            lock_owner = NULL,
            retry_count = COALESCE(retry_count, 0) + 1,
            updated_at = #{updatedAt}
        WHERE status = 'IN_PROGRESS'
          AND lock_at <![CDATA[<]]> #{timeout}
          AND COALESCE(retry_count, 0) + 1 <![CDATA[<]]> COALESCE(max_retries, 3)
    </update>

    <!-- 查询任务列表 -->
    <select id="selectTasks" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM market_scrape_task
        <where>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

</mapper>
