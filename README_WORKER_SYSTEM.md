# Ozon Scraper - ä»»åŠ¡é˜Ÿåˆ— + Workerç³»ç»Ÿ

## ç³»ç»Ÿæ¶æ„

æœ¬ç³»ç»Ÿå®ç°äº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ•°æ®æŠ“å–æ¶æ„ï¼ŒåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webç®¡ç†ç•Œé¢     â”‚  â† ç›‘æ§å’Œç®¡ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯APIæœåŠ¡     â”‚  â† ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨Worker    â”‚  â† åˆ†å¸ƒå¼æŠ“å–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶è¯´æ˜

1. **åç«¯APIæœåŠ¡** (Spring Boot)
   - ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
   - Workeræ³¨å†Œå’Œå¿ƒè·³
   - ä»»åŠ¡åˆ†é…å’ŒçŠ¶æ€è·Ÿè¸ª
   - æ•°æ®æŒä¹…åŒ–

2. **æµè§ˆå™¨Worker** (Tampermonkeyè„šæœ¬)
   - ä»é˜Ÿåˆ—æ‹‰å–ä»»åŠ¡
   - æ‰§è¡Œæ•°æ®æŠ“å–
   - ä¸ŠæŠ¥è¿›åº¦å’Œç»“æœ
   - æ”¯æŒæ–­ç‚¹ç»­è·‘

3. **Webç®¡ç†ç•Œé¢** (HTML/JavaScript)
   - Workerç›‘æ§
   - ä»»åŠ¡ç®¡ç†
   - ç»Ÿè®¡åˆ†æ
   - å®æ—¶åˆ·æ–°

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd d:\javaEverything\shopeeerp
mvn spring-boot:run
```

åç«¯æœåŠ¡å°†åœ¨ `http://localhost:8080` è¿è¡Œã€‚

### 2. æ‰“å¼€Webç®¡ç†ç•Œé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
```
http://localhost:8080/worker-management.html
```

### 3. å¯åŠ¨æµè§ˆå™¨Worker

1. å®‰è£…Tampermonkeyæµè§ˆå™¨æ‰©å±•
2. å®‰è£…è„šæœ¬ï¼š`scripts/browser_extension/ozon_scraper_auto.user.js`
3. è®¿é—® `https://www.ozon.ru/`
4. ç‚¹å‡»è„šæœ¬é¢æ¿ä¸­çš„"ğŸ¤– Workeræ¨¡å¼"æŒ‰é’®

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š[æµè§ˆå™¨Workerä½¿ç”¨æŒ‡å—](docs/browser_worker_usage.md)

### 4. æ·»åŠ ä»»åŠ¡

**æ–¹å¼1: é€šè¿‡Webç®¡ç†ç•Œé¢**
1. æ‰“å¼€ `http://localhost:8080/worker-management.html`
2. ç‚¹å‡»"â• æ·»åŠ ä»»åŠ¡"æŒ‰é’®
3. å¡«å†™ä»»åŠ¡ä¿¡æ¯å¹¶æäº¤

**æ–¹å¼2: é€šè¿‡API**
```bash
# Linux/Mac
./scripts/test_worker_api.sh

# Windows
scripts\test_worker_api.bat
```

**æ–¹å¼3: ä½¿ç”¨curl**
```bash
curl -X POST http://localhost:8080/market/tasks/enqueue \
  -H "Content-Type: application/json" \
  -d '{
    "tasks": [
      {
        "platform": "ozon",
        "market": "RU",
        "url": "https://www.ozon.ru/product/...",
        "data_type": "product_detail",
        "priority": 1
      }
    ]
  }'
```

## æ–‡æ¡£

- [æµè§ˆå™¨Workerä½¿ç”¨æŒ‡å—](docs/browser_worker_usage.md) - è¯¦ç»†çš„Workeræ¨¡å¼ä½¿ç”¨è¯´æ˜
- [Webç®¡ç†ç•Œé¢ä½¿ç”¨æŒ‡å—](docs/web_management_usage.md) - ç®¡ç†ç•Œé¢åŠŸèƒ½è¯´æ˜
- [APIæ–‡æ¡£](docs/api_documentation.md) - åç«¯APIæ¥å£æ–‡æ¡£ï¼ˆå¾…åˆ›å»ºï¼‰

## æµ‹è¯•è„šæœ¬

### Worker APIæµ‹è¯•
```bash
# Linux/Mac
./scripts/test_worker_api.sh

# Windows
scripts\test_worker_api.bat
```

### Webç®¡ç†ç•Œé¢æµ‹è¯•
```bash
# Linux/Mac
./scripts/test_web_management.sh

# Windows
scripts\test_web_management.bat
```

## æ ¸å¿ƒåŠŸèƒ½

### ä»»åŠ¡é˜Ÿåˆ—
- âœ… ä»»åŠ¡å…¥é˜Ÿï¼ˆæ‰¹é‡æ·»åŠ ï¼‰
- âœ… ä»»åŠ¡æ‹‰å–ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
- âœ… ä»»åŠ¡é”å®šï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰
- âœ… ä»»åŠ¡å®Œæˆï¼ˆçŠ¶æ€æ›´æ–°ï¼‰
- âœ… ä»»åŠ¡é‡è¯•ï¼ˆå¤±è´¥è‡ªåŠ¨é‡è¯•ï¼‰
- âœ… è¶…æ—¶é‡Šæ”¾ï¼ˆè‡ªåŠ¨é‡Šæ”¾è¶…æ—¶ä»»åŠ¡ï¼‰

### Workerç®¡ç†
- âœ… Workeræ³¨å†Œï¼ˆå”¯ä¸€IDï¼‰
- âœ… å¿ƒè·³æœºåˆ¶ï¼ˆ60ç§’é—´éš”ï¼‰
- âœ… çŠ¶æ€è·Ÿè¸ªï¼ˆåœ¨çº¿/ç¦»çº¿/å¿™ç¢Œï¼‰
- âœ… ä»»åŠ¡ç»Ÿè®¡ï¼ˆæ€»æ•°/æˆåŠŸ/å¤±è´¥ï¼‰
- âœ… æ–­ç‚¹ç»­è·‘ï¼ˆæµè§ˆå™¨é‡å¯æ¢å¤ï¼‰

### æ•°æ®æŠ“å–
- âœ… å•†å“è¯¦æƒ…é¡µæŠ“å–
- âœ… åˆ†ç±»åˆ—è¡¨é¡µæŠ“å–
- âœ… è¿›åº¦å®æ—¶ä¸ŠæŠ¥
- âœ… é”€é‡æ•°æ®è¡¥å……
- âœ… åªä¿å­˜æœ‰é”€é‡å•†å“

### Webç®¡ç†
- âœ… Workerç›‘æ§é¡µé¢
- âœ… ä»»åŠ¡ç®¡ç†é¡µé¢
- âœ… ç»Ÿè®¡åˆ†æé¡µé¢
- âœ… æ·»åŠ ä»»åŠ¡åŠŸèƒ½
- âœ… è‡ªåŠ¨åˆ·æ–°ï¼ˆ10ç§’ï¼‰

## æ•°æ®åº“è¡¨

### market_scrape_task
ä»»åŠ¡é˜Ÿåˆ—è¡¨ï¼Œå­˜å‚¨æ‰€æœ‰æŠ“å–ä»»åŠ¡ã€‚

**å…³é”®å­—æ®µ**:
- `id`: ä»»åŠ¡ID
- `platform`: å¹³å°ï¼ˆozonï¼‰
- `market`: å¸‚åœºï¼ˆRUï¼‰
- `url`: ç›®æ ‡URL
- `data_type`: æ•°æ®ç±»å‹ï¼ˆproduct_detail/category_listï¼‰
- `status`: çŠ¶æ€ï¼ˆPENDING/IN_PROGRESS/DONE/FAILED/RETRYï¼‰
- `priority`: ä¼˜å…ˆçº§ï¼ˆ1-10ï¼‰
- `lock_owner`: é”å®šçš„Worker ID
- `lock_at`: é”å®šæ—¶é—´
- `retry_count`: é‡è¯•æ¬¡æ•°
- `max_retries`: æœ€å¤§é‡è¯•æ¬¡æ•°

### market_scrape_worker
Workeræ³¨å†Œè¡¨ï¼Œå­˜å‚¨æ‰€æœ‰Workerä¿¡æ¯ã€‚

**å…³é”®å­—æ®µ**:
- `id`: Workerè®°å½•ID
- `worker_id`: Workerå”¯ä¸€ID
- `worker_name`: Workeråç§°
- `browser_type`: æµè§ˆå™¨ç±»å‹
- `status`: çŠ¶æ€ï¼ˆidle/busy/offlineï¼‰
- `current_task_id`: å½“å‰ä»»åŠ¡ID
- `total_tasks`: æ€»ä»»åŠ¡æ•°
- `success_tasks`: æˆåŠŸä»»åŠ¡æ•°
- `failed_tasks`: å¤±è´¥ä»»åŠ¡æ•°
- `last_heartbeat`: æœ€åå¿ƒè·³æ—¶é—´

## APIç«¯ç‚¹

### Workerç›¸å…³
- `POST /market/workers/register` - Workeræ³¨å†Œ
- `POST /market/workers/heartbeat` - å‘é€å¿ƒè·³
- `GET /market/workers/list` - æŸ¥è¯¢åœ¨çº¿Worker

### ä»»åŠ¡ç›¸å…³
- `POST /market/tasks/enqueue` - æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
- `POST /market/tasks/pull` - æ‹‰å–ä»»åŠ¡
- `POST /market/tasks/update` - æ›´æ–°ä»»åŠ¡è¿›åº¦
- `POST /market/tasks/complete` - å®Œæˆä»»åŠ¡
- `GET /market/tasks/list` - æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨

## å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·æ·»åŠ ä»»åŠ¡
   â†“
2. ä»»åŠ¡è¿›å…¥é˜Ÿåˆ—ï¼ˆPENDINGï¼‰
   â†“
3. Workeræ‹‰å–ä»»åŠ¡ï¼ˆIN_PROGRESSï¼‰
   â†“
4. Workeræ‰§è¡ŒæŠ“å–
   â†“
5. Workerä¸ŠæŠ¥è¿›åº¦
   â†“
6. Workerå®Œæˆä»»åŠ¡ï¼ˆDONE/FAILEDï¼‰
   â†“
7. å¤±è´¥ä»»åŠ¡è‡ªåŠ¨é‡è¯•ï¼ˆRETRYï¼‰
```

### Workerç”Ÿå‘½å‘¨æœŸ

```
1. Workerå¯åŠ¨
   â†“
2. æ³¨å†Œåˆ°åç«¯
   â†“
3. å¼€å§‹å‘é€å¿ƒè·³ï¼ˆæ¯60ç§’ï¼‰
   â†“
4. å¼€å§‹æ‹‰å–ä»»åŠ¡ï¼ˆæ¯5ç§’ï¼‰
   â†“
5. å¤„ç†ä»»åŠ¡
   â†“
6. ä¸ŠæŠ¥ç»“æœ
   â†“
7. ç»§ç»­æ‹‰å–ä¸‹ä¸€ä¸ªä»»åŠ¡
```

## é…ç½®è¯´æ˜

### åç«¯é…ç½®

**application.properties**:
```properties
server.port=8080
spring.datasource.url=jdbc:mysql://localhost:3306/shopeeerp
spring.datasource.username=root
spring.datasource.password=your_password
```

### Workeré…ç½®

**ozon_scraper_auto.user.js**:
```javascript
const WORKER_CONFIG = {
    enabled: false,              // Workeræ¨¡å¼æ˜¯å¦å¯ç”¨
    workerId: null,              // Workerå”¯ä¸€IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    workerName: 'Browser Worker', // Workeråç§°
    heartbeatInterval: 60000,    // å¿ƒè·³é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    pullInterval: 5000,          // æ‹‰å–ä»»åŠ¡é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    maxTasksPerPull: 1,          // æ¯æ¬¡æ‹‰å–çš„ä»»åŠ¡æ•°
};
```

## éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
- 1ä¸ªåç«¯æœåŠ¡å®ä¾‹
- 1-2ä¸ªæµè§ˆå™¨Worker
- æœ¬åœ°MySQLæ•°æ®åº“

### ç”Ÿäº§ç¯å¢ƒ
- 1ä¸ªåç«¯æœåŠ¡å®ä¾‹ï¼ˆå¯æ‰©å±•ï¼‰
- å¤šä¸ªæµè§ˆå™¨Workerï¼ˆåˆ†å¸ƒåœ¨ä¸åŒæœºå™¨ï¼‰
- ç‹¬ç«‹çš„MySQLæ•°æ®åº“æœåŠ¡å™¨
- æ·»åŠ è®¤è¯å’Œè®¿é—®æ§åˆ¶
- é…ç½®HTTPS

## ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¸¸ç›‘æ§
1. æ£€æŸ¥Webç®¡ç†ç•Œé¢çš„ç»Ÿè®¡æ•°æ®
2. ç¡®ä¿æœ‰è¶³å¤Ÿçš„Workeråœ¨çº¿
3. ç›‘æ§å¤±è´¥ä»»åŠ¡æ•°é‡
4. æŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦

### å®šæœŸç»´æŠ¤
1. æ¸…ç†å·²å®Œæˆçš„æ—§ä»»åŠ¡
2. æ£€æŸ¥æ•°æ®åº“æ€§èƒ½
3. æ›´æ–°Workerè„šæœ¬ç‰ˆæœ¬
4. å¤‡ä»½æ•°æ®åº“

### æ•…éšœå¤„ç†
1. Workerç¦»çº¿ï¼šé‡å¯æµè§ˆå™¨æˆ–æ£€æŸ¥ç½‘ç»œ
2. ä»»åŠ¡å †ç§¯ï¼šå¢åŠ Workeræ•°é‡
3. ä»»åŠ¡å¤±è´¥ï¼šæ£€æŸ¥URLå’Œé…ç½®
4. æ•°æ®åº“æ…¢ï¼šä¼˜åŒ–ç´¢å¼•å’ŒæŸ¥è¯¢

## æ€§èƒ½ä¼˜åŒ–

### åç«¯ä¼˜åŒ–
- ä½¿ç”¨è¿æ¥æ± 
- æ·»åŠ æ•°æ®åº“ç´¢å¼•
- å®ç°ä»»åŠ¡ç¼“å­˜
- ä¼˜åŒ–SQLæŸ¥è¯¢

### Workerä¼˜åŒ–
- è°ƒæ•´æ‹‰å–é—´éš”
- å¢åŠ å¹¶å‘Workeræ•°
- ä¼˜åŒ–æŠ“å–é€»è¾‘
- å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚

### æ•°æ®åº“ä¼˜åŒ–
- å®šæœŸæ¸…ç†æ—§æ•°æ®
- æ·»åŠ åˆé€‚çš„ç´¢å¼•
- åˆ†åŒºå¤§è¡¨
- ä½¿ç”¨è¯»å†™åˆ†ç¦»

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **è®¿é—®æ§åˆ¶**: æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæˆæƒ
2. **CORSé…ç½®**: é™åˆ¶å…è®¸çš„æ¥æº
3. **SQLæ³¨å…¥**: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
4. **XSSé˜²æŠ¤**: å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰
5. **é€Ÿç‡é™åˆ¶**: é˜²æ­¢APIæ»¥ç”¨
6. **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

## ç‰ˆæœ¬å†å²

### v2.8 (å½“å‰ç‰ˆæœ¬)
- âœ… å®ç°Workeræ¨¡å¼
- âœ… å®ç°ä»»åŠ¡é˜Ÿåˆ—API
- âœ… å®ç°Webç®¡ç†ç•Œé¢
- âœ… æ”¯æŒæ–­ç‚¹ç»­è·‘
- âœ… è‡ªåŠ¨è¶…æ—¶é‡Šæ”¾

### v2.7 (ä¹‹å‰ç‰ˆæœ¬)
- ç‹¬ç«‹æ¨¡å¼æŠ“å–
- å®šæ—¶ä»»åŠ¡
- åˆ†ç±»éå†

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œæå‡ºå»ºè®®ï¼

### å¼€å‘æµç¨‹
1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç 
4. åˆ›å»ºPull Request

### ä»£ç è§„èŒƒ
- Java: éµå¾ªé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ
- JavaScript: ä½¿ç”¨ESLint
- æ³¨é‡Š: ä¸­æ–‡æ³¨é‡Šï¼Œæ¸…æ™°æ˜äº†

## è®¸å¯è¯

MIT License

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueã€‚

## è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œä½¿ç”¨è€…ï¼
